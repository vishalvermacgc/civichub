<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Report New Issue</title>
  
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
  />
  <style>
    body {
  font-family: sans-serif;
  margin: 0;
  background: #f1f1f1;
}

.report-form {
  max-width: 500px;
  margin: 40px auto;
  background: white;
  padding: 25px;
  border-radius: 12px;
  box-shadow: 0 0 15px rgba(0,0,0,0.1);
}

.report-form h2 {
  text-align: center;
  margin-bottom: 20px;
}

form label {
  display: block;
  margin-top: 15px;
  font-weight: bold;
}

input[type="file"],
input[type="text"],
select,
textarea {
  width: 100%;
  margin-top: 6px;
  padding: 10px;
  border-radius: 6px;
  border: 1px solid #ccc;
  font-size: 1rem;
}

textarea {
  resize: vertical;
}

.checkbox {
  display: flex;
  align-items: center;
  margin-top: 15px;
}

.checkbox input {
  margin-right: 8px;
}

button {
  width: 100%;
  margin-top: 20px;
  padding: 12px;
  background: #6a5acd;
  color: white;
  border: none;
  font-size: 1rem;
  border-radius: 6px;
  cursor: pointer;
}

button:hover {
  background: #483d8b;
}

#map {
  height: 250px;
  width: 100%;
  margin-top: 10px;
  border-radius: 10px;
}

  </style>
</head>
<body>
  <section class="report-form">
    <h2>üìù Report New Issue</h2>

    <form id="issueForm">
      <!-- Upload -->
      <label for="photo">Add/Upload Photo</label>
      <input type="file" id="photo" accept="image/*" multiple />

      <!-- Map -->
      <div id="map"></div>
      <input type="text" id="address" readonly placeholder="Detecting address..." />

      <!-- Category -->
      <select id="category" required>
        <option value="">Select Category</option>
        <option value="Streetlight">Streetlight</option>
        <option value="Garbage">Garbage</option>
        <option value="Pothole">Pothole</option>
        <option value="Water Leakage">Water Leakage</option>
      </select>

      <!-- Description -->
      <textarea id="description" rows="4" placeholder="Describe the issue..." required></textarea>

      <!-- Anonymous -->
      <label class="checkbox">
        <input type="checkbox" id="anonymous" />
        Report Anonymous
      </label>

      <!-- Submit -->
      <button type="submit">Submit Issue</button>
    </form>
  </section>

  <script>
  // Address Detection using Geolocation
  window.onload = function () {
    if ("geolocation" in navigator) {
      navigator.geolocation.getCurrentPosition(async (position) => {
        const { latitude, longitude } = position.coords;

        // Show coordinates on map (you can enhance this later)
        document.getElementById("map").innerHTML =
          `<iframe width="100%" height="150" style="border:0" 
            src="https://www.google.com/maps?q=${latitude},${longitude}&hl=es&z=14&output=embed">
          </iframe>`;

        // Get readable address using Nominatim API
        const response = await fetch(
          `https://nominatim.openstreetmap.org/reverse?lat=${latitude}&lon=${longitude}&format=json`
        );
        const data = await response.json();
        document.getElementById("address").value = data.display_name;
      });
    } else {
      document.getElementById("address").value = "Location not available";
    }
  };

  // Convert file(s) to Base64
  function getBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => resolve(reader.result);
      reader.onerror = (error) => reject(error);
    });
  }

  // Form Submission
  document.getElementById("issueForm").addEventListener("submit", async function (e) {
    e.preventDefault();

    const files = document.getElementById("photo").files;
    const photos = [];

    for (let i = 0; i < files.length; i++) {
      const base64 = await getBase64(files[i]);
      photos.push(base64);
    }

    const report = {
      id: Date.now(),
      address: document.getElementById("address").value,
      category: document.getElementById("category").value,
      description: document.getElementById("description").value,
      anonymous: document.getElementById("anonymous").checked,
      photos: photos,
      timestamp: new Date().toLocaleString()
    };

    let allReports = JSON.parse(localStorage.getItem("reports")) || [];
    allReports.push(report);
    localStorage.setItem("reports", JSON.stringify(allReports));

    alert("Issue submitted successfully!");
    window.location.href = "index.html";
  });
</script>

</body>
</html>
